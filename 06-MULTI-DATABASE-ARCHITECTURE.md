# Multi-Database Architecture for Microservices

## ğŸ“‹ Table of Contents
1. [Overview](#overview)
2. [Database-per-Service Pattern](#database-per-service-pattern)
3. [Architecture Diagram](#architecture-diagram)
4. [Database Ownership Matrix](#database-ownership-matrix)
5. [Read/Write Permission Model](#readwrite-permission-model)
6. [Data Synchronization Strategies](#data-synchronization-strategies)
7. [Database Technology Selection](#database-technology-selection)
8. [Implementation Guidelines](#implementation-guidelines)

---

## Overview

### Why Database-per-Service?

In a microservices architecture, each service should own its data. This pattern provides:

| Benefit | Description |
|---------|-------------|
| **Loose Coupling** | Services can evolve independently |
| **Technology Freedom** | Each service chooses optimal database |
| **Fault Isolation** | Database failure doesn't cascade |
| **Scalability** | Scale databases independently |
| **Security** | Fine-grained access control per service |

### The Challenge for Government Services

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    THE DATA SHARING CHALLENGE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  Problem: Multiple services need citizen data, but:                        â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   Permits   â”‚    â”‚   Revenue   â”‚    â”‚   Parks     â”‚                    â”‚
â”‚  â”‚   Service   â”‚    â”‚   Service   â”‚    â”‚   Service   â”‚                    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  â”‚ Needs:      â”‚    â”‚ Needs:      â”‚    â”‚ Needs:      â”‚                    â”‚
â”‚  â”‚ â€¢ Citizen   â”‚    â”‚ â€¢ Citizen   â”‚    â”‚ â€¢ Citizen   â”‚                    â”‚
â”‚  â”‚   name      â”‚    â”‚   name      â”‚    â”‚   name      â”‚                    â”‚
â”‚  â”‚ â€¢ Address   â”‚    â”‚ â€¢ Address   â”‚    â”‚ â€¢ Phone     â”‚                    â”‚
â”‚  â”‚ â€¢ Phone     â”‚    â”‚ â€¢ SSN/NID   â”‚    â”‚ â€¢ Email     â”‚                    â”‚
â”‚  â”‚ â€¢ Property  â”‚    â”‚ â€¢ Property  â”‚    â”‚ â€¢ Payment   â”‚                    â”‚
â”‚  â”‚   info      â”‚    â”‚   info      â”‚    â”‚   history   â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                            â”‚
â”‚  âŒ Bad: All services query Central Auth DB directly                      â”‚
â”‚  âŒ Bad: Duplicate citizen data everywhere (sync nightmare)               â”‚
â”‚  âœ… Good: Event-driven data sync with clear ownership                     â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database-per-Service Pattern

### Core Principles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 DATABASE-PER-SERVICE ARCHITECTURE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                    CENTRAL AUTH SERVICE                          â”‚      â”‚
â”‚  â”‚                    (Identity Owner)                              â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚      â”‚
â”‚  â”‚  â”‚                  AUTH DATABASE                           â”‚    â”‚      â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚      â”‚
â”‚  â”‚  â”‚  â”‚ citizens  â”‚ â”‚   roles   â”‚ â”‚   permissions         â”‚  â”‚    â”‚      â”‚
â”‚  â”‚  â”‚  â”‚ employees â”‚ â”‚ departmentsâ”‚ â”‚   service_clients    â”‚  â”‚    â”‚      â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚      â”‚
â”‚  â”‚                           â”‚                                      â”‚      â”‚
â”‚  â”‚                     WRITE OWNER                                  â”‚      â”‚
â”‚  â”‚                     PUBLISHES EVENTS                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚           â”‚        EVENT BUS (Kafka/SNS)         â”‚                         â”‚
â”‚           â”‚  citizen.created, citizen.updated    â”‚                         â”‚
â”‚           â”‚  employee.assigned, role.changed     â”‚                         â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                              â”‚                                              â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚           â”‚                  â”‚                  â”‚                           â”‚
â”‚           â–¼                  â–¼                  â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ PERMITS SERVICEâ”‚ â”‚REVENUE SERVICE â”‚ â”‚ PARKS SERVICE  â”‚                  â”‚
â”‚  â”‚ (Read Replica) â”‚ â”‚ (Read Replica) â”‚ â”‚ (Read Replica) â”‚                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚  â”‚ permits_db     â”‚ â”‚ revenue_db     â”‚ â”‚ parks_db       â”‚                  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚
â”‚  â”‚ â”‚citizens_   â”‚ â”‚ â”‚ â”‚citizens_   â”‚ â”‚ â”‚ â”‚citizens_   â”‚ â”‚                  â”‚
â”‚  â”‚ â”‚cache       â”‚ â”‚ â”‚ â”‚cache       â”‚ â”‚ â”‚ â”‚cache       â”‚ â”‚                  â”‚
â”‚  â”‚ â”‚(READ ONLY) â”‚ â”‚ â”‚ â”‚(READ ONLY) â”‚ â”‚ â”‚ â”‚(READ ONLY) â”‚ â”‚                  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚
â”‚  â”‚ â”‚permits     â”‚ â”‚ â”‚ â”‚tax_records â”‚ â”‚ â”‚ â”‚bookings    â”‚ â”‚                  â”‚
â”‚  â”‚ â”‚applicationsâ”‚ â”‚ â”‚ â”‚payments    â”‚ â”‚ â”‚ â”‚facilities  â”‚ â”‚                  â”‚
â”‚  â”‚ â”‚(READ/WRITE)â”‚ â”‚ â”‚ â”‚(READ/WRITE)â”‚ â”‚ â”‚ â”‚(READ/WRITE)â”‚ â”‚                  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Isolation Levels

| Isolation Level | Description | Use Case |
|-----------------|-------------|----------|
| **Logical** | Separate schemas in same DB instance | Development, small deployments |
| **Instance** | Separate DB instances, same server | Medium deployments |
| **Physical** | Completely separate DB servers | Production, compliance requirements |

---

## Architecture Diagram

### Complete Multi-Database Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GOVERNMENT SERVICES - MULTI-DATABASE ARCHITECTURE                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                              CLIENT LAYER                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ Citizen App â”‚  â”‚ Employee    â”‚  â”‚ Admin       â”‚  â”‚ Third-Party â”‚           â”‚  â”‚
â”‚  â”‚  â”‚ (Mobile/Web)â”‚  â”‚ Portal      â”‚  â”‚ Dashboard   â”‚  â”‚ Integrationsâ”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                â”‚                â”‚                â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                      â”‚                                               â”‚
â”‚                                      â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           API GATEWAY LAYER                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Kong / AWS API Gateway / Nginx                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Rate Limiting  â€¢ SSL Termination  â€¢ Request Routing  â€¢ Auth Header   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                               â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚            â”‚                         â”‚                         â”‚                     â”‚
â”‚            â–¼                         â–¼                         â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  AUTH SERVICE    â”‚    â”‚ PERMITS SERVICE  â”‚    â”‚ REVENUE SERVICE  â”‚               â”‚
â”‚  â”‚  (Master)        â”‚    â”‚ (Domain Owner)   â”‚    â”‚ (Domain Owner)   â”‚               â”‚
â”‚  â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚               â”‚
â”‚  â”‚  Write: âœ…       â”‚    â”‚  Write: âœ…       â”‚    â”‚  Write: âœ…       â”‚               â”‚
â”‚  â”‚  - Citizens      â”‚    â”‚  - Permits       â”‚    â”‚  - Tax Records   â”‚               â”‚
â”‚  â”‚  - Employees     â”‚    â”‚  - Applications  â”‚    â”‚  - Payments      â”‚               â”‚
â”‚  â”‚  - Roles         â”‚    â”‚  - Inspections   â”‚    â”‚  - Licenses      â”‚               â”‚
â”‚  â”‚  - Permissions   â”‚    â”‚                  â”‚    â”‚                  â”‚               â”‚
â”‚  â”‚                  â”‚    â”‚  Read Only: ğŸ“–   â”‚    â”‚  Read Only: ğŸ“–   â”‚               â”‚
â”‚  â”‚  Publishes:      â”‚    â”‚  - Citizens      â”‚    â”‚  - Citizens      â”‚               â”‚
â”‚  â”‚  citizen.events  â”‚    â”‚  (cached copy)   â”‚    â”‚  (cached copy)   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚           â”‚                       â”‚                       â”‚                          â”‚
â”‚           â–¼                       â–¼                       â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   PostgreSQL     â”‚    â”‚   PostgreSQL     â”‚    â”‚   PostgreSQL     â”‚               â”‚
â”‚  â”‚   auth_db        â”‚    â”‚   permits_db     â”‚    â”‚   revenue_db     â”‚               â”‚
â”‚  â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚               â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚
â”‚  â”‚ â”‚ citizens     â”‚ â”‚    â”‚ â”‚ citizen_refs â”‚ â”‚    â”‚ â”‚ citizen_refs â”‚ â”‚               â”‚
â”‚  â”‚ â”‚ (SOURCE)     â”‚ â”‚    â”‚ â”‚ (READ ONLY)  â”‚ â”‚    â”‚ â”‚ (READ ONLY)  â”‚ â”‚               â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚
â”‚  â”‚ â”‚ employees    â”‚ â”‚    â”‚ â”‚ permits      â”‚ â”‚    â”‚ â”‚ tax_records  â”‚ â”‚               â”‚
â”‚  â”‚ â”‚ roles        â”‚ â”‚    â”‚ â”‚ applications â”‚ â”‚    â”‚ â”‚ payments     â”‚ â”‚               â”‚
â”‚  â”‚ â”‚ permissions  â”‚ â”‚    â”‚ â”‚ inspections  â”‚ â”‚    â”‚ â”‚ licenses     â”‚ â”‚               â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚           â”‚                       â–²                       â–²                          â”‚
â”‚           â”‚                       â”‚                       â”‚                          â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚           â”‚  â”‚                                                                       â”‚
â”‚           â–¼  â–¼                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         EVENT BUS LAYER                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Apache Kafka / AWS EventBridge / RabbitMQ                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Topics:                                                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ gov.auth.citizen.created    â€¢ gov.auth.citizen.updated              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ gov.auth.citizen.deleted    â€¢ gov.auth.employee.assigned            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ gov.permits.application.submitted                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ gov.revenue.payment.completed                                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Ownership Matrix

### Service-to-Database Mapping

| Service | Owned Database | Write Access | Read Access (Cached) |
|---------|---------------|--------------|---------------------|
| **Auth Service** | `auth_db` | citizens, employees, roles, permissions, sessions | - |
| **Permits Service** | `permits_db` | permits, applications, inspections | citizens (cache), properties (cache) |
| **Revenue Service** | `revenue_db` | tax_records, payments, business_licenses | citizens (cache), properties (cache) |
| **Parks Service** | `parks_db` | facilities, bookings, programs | citizens (cache) |
| **Public Works** | `public_works_db` | service_requests, work_orders | citizens (cache), properties (cache) |
| **Clerk Service** | `clerk_db` | vital_records, public_records | citizens (cache) |
| **Notification** | `notification_db` | notifications, templates, delivery_logs | citizens (cache) |
| **Payment Gateway** | `payment_db` | transactions, payment_methods | citizens (cache) |
| **Document Storage** | `documents_db` | documents, metadata, access_logs | citizens (cache) |

### Table Ownership Rules

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TABLE OWNERSHIP RULES                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  RULE 1: Single Writer Principle                                           â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                          â”‚
â”‚  Each table has EXACTLY ONE service that can write to it.                  â”‚
â”‚  Other services can only READ a cached/projected copy.                     â”‚
â”‚                                                                            â”‚
â”‚  RULE 2: Reference Tables                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                               â”‚
â”‚  Services maintain a "reference" copy of external data they need.          â”‚
â”‚  These copies are updated via events, never directly.                      â”‚
â”‚                                                                            â”‚
â”‚  Example:                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  permits_db.citizen_refs (READ ONLY COPY)                        â”‚      â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚      â”‚
â”‚  â”‚  citizen_id      BIGINT PRIMARY KEY  -- Same as auth_db          â”‚      â”‚
â”‚  â”‚  name            VARCHAR(255)        -- Cached from event        â”‚      â”‚
â”‚  â”‚  email           VARCHAR(255)        -- Cached from event        â”‚      â”‚
â”‚  â”‚  phone           VARCHAR(50)         -- Cached from event        â”‚      â”‚
â”‚  â”‚  address         TEXT                -- Cached from event        â”‚      â”‚
â”‚  â”‚  last_synced_at  TIMESTAMP           -- Track freshness          â”‚      â”‚
â”‚  â”‚  event_version   BIGINT              -- Prevent old updates      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                            â”‚
â”‚  RULE 3: Eventual Consistency                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                           â”‚
â”‚  Accept that reference data may be slightly stale (milliseconds).          â”‚
â”‚  Design UI/UX to handle this gracefully.                                   â”‚
â”‚                                                                            â”‚
â”‚  RULE 4: No Cross-Database Joins                                           â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                           â”‚
â”‚  Services NEVER join across databases. Use event-driven data copies        â”‚
â”‚  or API calls for cross-service queries.                                   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Read/Write Permission Model

### Permission Enforcement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE PERMISSION ENFORCEMENT                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    AUTH SERVICE DATABASE                             â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Database User: auth_service_user                                    â”‚  â”‚
â”‚  â”‚  Permissions: ALL PRIVILEGES on auth_db.*                            â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  -- Create dedicated write user                                      â”‚  â”‚
â”‚  â”‚  CREATE USER 'auth_service_user'@'%' IDENTIFIED BY '<secure>';       â”‚  â”‚
â”‚  â”‚  GRANT ALL PRIVILEGES ON auth_db.* TO 'auth_service_user'@'%';       â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  -- No other service can write to auth_db                            â”‚  â”‚
â”‚  â”‚  -- Read replicas for analytics only                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    PERMITS SERVICE DATABASE                          â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Database User: permits_service_user                                 â”‚  â”‚
â”‚  â”‚  Permissions:                                                        â”‚  â”‚
â”‚  â”‚    - ALL PRIVILEGES on permits_db.permits                            â”‚  â”‚
â”‚  â”‚    - ALL PRIVILEGES on permits_db.applications                       â”‚  â”‚
â”‚  â”‚    - ALL PRIVILEGES on permits_db.inspections                        â”‚  â”‚
â”‚  â”‚    - SELECT ONLY on permits_db.citizen_refs  <-- READ ONLY!          â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  -- Write permissions for owned tables                               â”‚  â”‚
â”‚  â”‚  GRANT ALL ON permits_db.permits TO 'permits_service_user'@'%';      â”‚  â”‚
â”‚  â”‚  GRANT ALL ON permits_db.applications TO 'permits_service_user'@'%'; â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  -- Read-only for cached citizen data                                â”‚  â”‚
â”‚  â”‚  GRANT SELECT ON permits_db.citizen_refs TO 'permits_service_user';  â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  -- Special sync user for event consumer                             â”‚  â”‚
â”‚  â”‚  CREATE USER 'permits_sync_user'@'%' IDENTIFIED BY '<secure>';       â”‚  â”‚
â”‚  â”‚  GRANT INSERT, UPDATE ON permits_db.citizen_refs TO 'permits_sync';  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Service Account Matrix

| Service | Database | Tables | Permission Level |
|---------|----------|--------|------------------|
| auth_service_user | auth_db | citizens, employees, roles, permissions | ALL (Owner) |
| auth_service_user | auth_db | sessions, audit_logs | ALL (Owner) |
| permits_service_user | permits_db | permits, applications, inspections | ALL (Owner) |
| permits_service_user | permits_db | citizen_refs | SELECT ONLY |
| permits_sync_user | permits_db | citizen_refs | INSERT, UPDATE (Sync) |
| revenue_service_user | revenue_db | tax_records, payments | ALL (Owner) |
| revenue_service_user | revenue_db | citizen_refs | SELECT ONLY |
| revenue_sync_user | revenue_db | citizen_refs | INSERT, UPDATE (Sync) |

### Read Replica Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    READ REPLICA FOR ANALYTICS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Auth Primary  â”‚â”€â”€â”€â”€â”€ Replication â”€â”€â–¶â”‚  Auth Replica   â”‚               â”‚
â”‚  â”‚   (Write Only)  â”‚                    â”‚  (Read Only)    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                  â”‚                         â”‚
â”‚                                                  â–¼                         â”‚
â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                                         â”‚   Analytics     â”‚               â”‚
â”‚                                         â”‚   Dashboard     â”‚               â”‚
â”‚                                         â”‚   (Read Only)   â”‚               â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                            â”‚
â”‚  Benefits:                                                                 â”‚
â”‚  â€¢ No analytics queries on primary                                        â”‚
â”‚  â€¢ Separate connection pool                                                â”‚
â”‚  â€¢ Can scale read replicas independently                                   â”‚
â”‚  â€¢ Cross-region replicas for disaster recovery                            â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Synchronization Strategies

### Strategy 1: Event-Driven Sync (Recommended)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EVENT-DRIVEN SYNCHRONIZATION                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  1. Auth Service updates citizen                                           â”‚
â”‚     UPDATE citizens SET phone = '+1-555-0199' WHERE id = 123;              â”‚
â”‚                                                                            â”‚
â”‚  2. Auth Service publishes event                                           â”‚
â”‚     {                                                                      â”‚
â”‚       "event_type": "citizen.updated",                                     â”‚
â”‚       "event_id": "evt_abc123",                                            â”‚
â”‚       "event_version": 42,                                                 â”‚
â”‚       "timestamp": "2024-01-15T10:30:00Z",                                 â”‚
â”‚       "data": {                                                            â”‚
â”‚         "citizen_id": 123,                                                 â”‚
â”‚         "changes": {                                                       â”‚
â”‚           "phone": {                                                       â”‚
â”‚             "old": "+1-555-0100",                                          â”‚
â”‚             "new": "+1-555-0199"                                           â”‚
â”‚           }                                                                â”‚
â”‚         },                                                                 â”‚
â”‚         "snapshot": {                                                      â”‚
â”‚           "id": 123,                                                       â”‚
â”‚           "name": "Maria Garcia",                                          â”‚
â”‚           "email": "maria@email.com",                                      â”‚
â”‚           "phone": "+1-555-0199",                                          â”‚
â”‚           "address": "456 Main St"                                         â”‚
â”‚         }                                                                  â”‚
â”‚       }                                                                    â”‚
â”‚     }                                                                      â”‚
â”‚                                                                            â”‚
â”‚  3. All subscribed services receive event                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚     â”‚   Permits   â”‚  â”‚   Revenue   â”‚  â”‚    Parks    â”‚                     â”‚
â”‚     â”‚   Consumer  â”‚  â”‚   Consumer  â”‚  â”‚   Consumer  â”‚                     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚            â”‚                â”‚                â”‚                             â”‚
â”‚            â–¼                â–¼                â–¼                             â”‚
â”‚     UPDATE citizen_refs SET phone = '+1-555-0199'                         â”‚
â”‚     WHERE citizen_id = 123 AND event_version < 42;                        â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Strategy 2: API-Based Lookup (On-Demand)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API-BASED DATA LOOKUP                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  Use Case: Need fresh data not in cache, or detailed data                  â”‚
â”‚                                                                            â”‚
â”‚  1. Permits Service needs full citizen profile                             â”‚
â”‚                                                                            â”‚
â”‚  2. Permits Service calls Auth API                                         â”‚
â”‚     GET /api/v1/internal/citizens/123                                      â”‚
â”‚     Authorization: Bearer <service_token>                                  â”‚
â”‚                                                                            â”‚
â”‚  3. Auth Service returns data                                              â”‚
â”‚     {                                                                      â”‚
â”‚       "citizen": {                                                         â”‚
â”‚         "id": 123,                                                         â”‚
â”‚         "name": "Maria Garcia",                                            â”‚
â”‚         "email": "maria@email.com",                                        â”‚
â”‚         "phone": "+1-555-0199",                                            â”‚
â”‚         "identity_verified": true,                                         â”‚
â”‚         "verification_level": "full"                                       â”‚
â”‚       }                                                                    â”‚
â”‚     }                                                                      â”‚
â”‚                                                                            â”‚
â”‚  When to Use:                                                              â”‚
â”‚  â€¢ Data not available in local cache                                       â”‚
â”‚  â€¢ Need guaranteed fresh data (payment processing)                         â”‚
â”‚  â€¢ Infrequent access patterns                                              â”‚
â”‚  â€¢ Complex queries not suitable for caching                                â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Strategy 3: Hybrid Approach (Recommended)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HYBRID SYNCHRONIZATION                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DECISION TREE                                                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Need citizen data?                                                 â”‚   â”‚
â”‚  â”‚       â”‚                                                             â”‚   â”‚
â”‚  â”‚       â”œâ”€â”€ Basic info (name, email, phone)?                          â”‚   â”‚
â”‚  â”‚       â”‚       â””â”€â”€ Use LOCAL CACHE (citizen_refs table)              â”‚   â”‚
â”‚  â”‚       â”‚           â””â”€â”€ Updated via Kafka events                      â”‚   â”‚
â”‚  â”‚       â”‚                                                             â”‚   â”‚
â”‚  â”‚       â”œâ”€â”€ Sensitive info (SSN, financial)?                          â”‚   â”‚
â”‚  â”‚       â”‚       â””â”€â”€ Call AUTH API (never cache sensitive)             â”‚   â”‚
â”‚  â”‚       â”‚           â””â”€â”€ Log access for audit                          â”‚   â”‚
â”‚  â”‚       â”‚                                                             â”‚   â”‚
â”‚  â”‚       â”œâ”€â”€ Verification status (for payment)?                        â”‚   â”‚
â”‚  â”‚       â”‚       â””â”€â”€ Call AUTH API (need real-time accuracy)           â”‚   â”‚
â”‚  â”‚       â”‚           â””â”€â”€ Cache result for 5 minutes                    â”‚   â”‚
â”‚  â”‚       â”‚                                                             â”‚   â”‚
â”‚  â”‚       â””â”€â”€ Historical/analytical?                                    â”‚   â”‚
â”‚  â”‚               â””â”€â”€ Use READ REPLICA                                  â”‚   â”‚
â”‚  â”‚                   â””â”€â”€ Connect to auth_replica_db                    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Technology Selection

### Recommended Stack

| Component | Technology | Reason |
|-----------|------------|--------|
| **Primary Databases** | PostgreSQL 15+ | ACID, JSON support, extensions |
| **Caching Layer** | Redis Cluster | Fast reads, pub/sub capability |
| **Search** | Elasticsearch | Full-text search for records |
| **Time Series** | TimescaleDB | Audit logs, metrics |
| **Document Store** | MongoDB (optional) | Flexible document storage |

### PostgreSQL Configuration

```sql
-- Connection pooling configuration
-- Use PgBouncer for connection pooling

-- Database creation script
CREATE DATABASE auth_db;
CREATE DATABASE permits_db;
CREATE DATABASE revenue_db;
CREATE DATABASE parks_db;
CREATE DATABASE public_works_db;

-- Schema isolation within database
CREATE SCHEMA IF NOT EXISTS public;  -- Main tables
CREATE SCHEMA IF NOT EXISTS cache;   -- Cached external data
CREATE SCHEMA IF NOT EXISTS audit;   -- Audit logs

-- Example for permits_db
\c permits_db

-- Owned tables in public schema
CREATE TABLE public.permits (...);
CREATE TABLE public.applications (...);

-- Cached data in cache schema
CREATE TABLE cache.citizen_refs (
    citizen_id      BIGINT PRIMARY KEY,
    name            VARCHAR(255),
    email           VARCHAR(255),
    phone           VARCHAR(50),
    address         TEXT,
    last_synced_at  TIMESTAMPTZ DEFAULT NOW(),
    event_version   BIGINT DEFAULT 0
);

-- Create index for quick lookups
CREATE INDEX idx_citizen_refs_email ON cache.citizen_refs(email);
```

---

## Implementation Guidelines

### Database Connection Management

```python
# Python example using SQLAlchemy
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

class DatabaseManager:
    def __init__(self):
        # Primary database (read/write)
        self.primary_engine = create_engine(
            'postgresql://permits_user:pass@primary-db:5432/permits_db',
            pool_size=20,
            max_overflow=30,
            pool_pre_ping=True
        )
        
        # Read replica (read only)
        self.replica_engine = create_engine(
            'postgresql://permits_readonly:pass@replica-db:5432/permits_db',
            pool_size=10,
            max_overflow=20,
            pool_pre_ping=True
        )
        
        # Cache database connection (for citizen_refs)
        self.cache_engine = create_engine(
            'postgresql://permits_sync:pass@primary-db:5432/permits_db',
            pool_size=5,
            max_overflow=10
        )
    
    def get_write_session(self):
        """Use for owned tables only"""
        Session = sessionmaker(bind=self.primary_engine)
        return Session()
    
    def get_read_session(self):
        """Use for read operations"""
        Session = sessionmaker(bind=self.replica_engine)
        return Session()
```

### Event Consumer for Sync

```python
# Kafka consumer for citizen updates
from kafka import KafkaConsumer
import json

class CitizenSyncConsumer:
    def __init__(self, db_manager):
        self.consumer = KafkaConsumer(
            'gov.auth.citizen.created',
            'gov.auth.citizen.updated',
            'gov.auth.citizen.deleted',
            bootstrap_servers=['kafka:9092'],
            group_id='permits-service-citizen-sync',
            value_deserializer=lambda m: json.loads(m.decode('utf-8'))
        )
        self.db = db_manager
    
    def process_events(self):
        for message in self.consumer:
            event = message.value
            
            if event['event_type'] == 'citizen.created':
                self.handle_citizen_created(event['data'])
            elif event['event_type'] == 'citizen.updated':
                self.handle_citizen_updated(event['data'])
            elif event['event_type'] == 'citizen.deleted':
                self.handle_citizen_deleted(event['data'])
    
    def handle_citizen_updated(self, data):
        """Update local citizen cache with version check"""
        session = self.db.get_cache_session()
        
        # Only update if event version is newer
        session.execute("""
            INSERT INTO cache.citizen_refs 
                (citizen_id, name, email, phone, address, event_version, last_synced_at)
            VALUES 
                (:id, :name, :email, :phone, :address, :version, NOW())
            ON CONFLICT (citizen_id) DO UPDATE SET
                name = EXCLUDED.name,
                email = EXCLUDED.email,
                phone = EXCLUDED.phone,
                address = EXCLUDED.address,
                event_version = EXCLUDED.event_version,
                last_synced_at = NOW()
            WHERE citizen_refs.event_version < EXCLUDED.event_version
        """, {
            'id': data['snapshot']['id'],
            'name': data['snapshot']['name'],
            'email': data['snapshot']['email'],
            'phone': data['snapshot']['phone'],
            'address': data['snapshot']['address'],
            'version': data['event_version']
        })
        
        session.commit()
```

### Best Practices Checklist

- [ ] Each service has dedicated database credentials
- [ ] Sync users are separate from application users
- [ ] Connection pooling configured (PgBouncer recommended)
- [ ] Read replicas used for analytics/reporting
- [ ] Event versioning prevents out-of-order updates
- [ ] Idempotent event consumers
- [ ] Dead letter queues for failed events
- [ ] Monitoring for sync lag
- [ ] Regular cache consistency checks
