# Event-Driven Communication - Kafka, AWS & VPS Hosting Options

## ğŸ“‹ Table of Contents
1. [Overview](#overview)
2. [Event-Driven Architecture](#event-driven-architecture)
3. [Apache Kafka Implementation](#apache-kafka-implementation)
4. [AWS Services Integration](#aws-services-integration)
5. [VPS Hosting Options](#vps-hosting-options)
6. [Event Schema Design](#event-schema-design)
7. [Implementation Examples](#implementation-examples)
8. [Monitoring & Operations](#monitoring--operations)

---

## Overview

### Why Event-Driven?

Event-driven architecture enables loose coupling between microservices while maintaining data consistency across distributed databases.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EVENT-DRIVEN vs REQUEST-DRIVEN COMPARISON                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  REQUEST-DRIVEN (Synchronous)              EVENT-DRIVEN (Asynchronous)     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   HTTP    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Permits â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Auth   â”‚        â”‚  Auth   â”‚        â”‚ Permits â”‚  â”‚
â”‚  â”‚ Service â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Service â”‚        â”‚ Service â”‚        â”‚ Service â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Response â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚                   â”‚       â”‚
â”‚  Problems:                                     â”‚ Event             â”‚       â”‚
â”‚  â€¢ Tight coupling                              â–¼                   â”‚       â”‚
â”‚  â€¢ Auth must be available                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚       â”‚
â”‚  â€¢ Latency adds up                        â”‚  Event  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â€¢ Cascading failures                     â”‚   Bus   â”‚                      â”‚
â”‚                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                            â”‚
â”‚                                           Benefits:                        â”‚
â”‚                                           â€¢ Loose coupling                 â”‚
â”‚                                           â€¢ Fault tolerance                â”‚
â”‚                                           â€¢ Better scalability             â”‚
â”‚                                           â€¢ Replay capability              â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Event Types in Government Services

| Event Category | Examples | Subscribers |
|----------------|----------|-------------|
| **Identity Events** | citizen.created, citizen.updated, citizen.verified | All services |
| **Auth Events** | user.logged_in, role.assigned, permission.changed | Audit, Security |
| **Application Events** | permit.submitted, permit.approved, inspection.scheduled | Notifications, Revenue |
| **Payment Events** | payment.completed, payment.failed, refund.issued | All services |
| **Document Events** | document.uploaded, document.verified | Permits, Clerk |

---

## Event-Driven Architecture

### Complete Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EVENT-DRIVEN MICROSERVICES ARCHITECTURE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           PRODUCER SERVICES                                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚  â”‚  â”‚  AUTH SERVICE   â”‚  â”‚ PERMITS SERVICE â”‚  â”‚ REVENUE SERVICE â”‚               â”‚  â”‚
â”‚  â”‚  â”‚  (Publisher)    â”‚  â”‚  (Publisher)    â”‚  â”‚  (Publisher)    â”‚               â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚  â”‚
â”‚  â”‚  â”‚ citizen.created â”‚  â”‚ permit.submittedâ”‚  â”‚ payment.receivedâ”‚               â”‚  â”‚
â”‚  â”‚  â”‚ citizen.updated â”‚  â”‚ permit.approved â”‚  â”‚ payment.failed  â”‚               â”‚  â”‚
â”‚  â”‚  â”‚ role.assigned   â”‚  â”‚ inspection.done â”‚  â”‚ license.issued  â”‚               â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
â”‚  â”‚           â”‚                    â”‚                    â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                    â”‚                    â”‚                            â”‚
â”‚              â–¼                    â–¼                    â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          MESSAGE BROKER                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Option A: Apache Kafka          Option B: AWS Services                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   Kafka Cluster     â”‚         â”‚   EventBridge       â”‚              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚   (Event Router)    â”‚              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â”‚ Topic:        â”‚ â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â”‚ gov.auth.*    â”‚ â”‚                   â”‚                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â”‚ gov.permits.* â”‚ â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â”‚ gov.revenue.* â”‚ â”‚         â”‚         â”‚           â”‚              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â–¼         â–¼           â–¼              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚                     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   + Schema Registry â”‚    â”‚  SQS   â”‚ â”‚  SQS   â”‚ â”‚  SQS   â”‚          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   + ZooKeeper       â”‚    â”‚Queue 1 â”‚ â”‚Queue 2 â”‚ â”‚Queue 3 â”‚          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Option C: Self-Hosted (VPS)                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   RabbitMQ Cluster  â”‚ or â”‚   Redis Streams     â”‚                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   (AMQP Protocol)   â”‚    â”‚   (Lightweight)     â”‚                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                    â”‚                    â”‚                            â”‚
â”‚              â–¼                    â–¼                    â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          CONSUMER SERVICES                                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚  â”‚  â”‚  PERMITS SYNC   â”‚  â”‚  REVENUE SYNC   â”‚  â”‚  NOTIFICATION   â”‚               â”‚  â”‚
â”‚  â”‚  â”‚  (Consumer)     â”‚  â”‚  (Consumer)     â”‚  â”‚  (Consumer)     â”‚               â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚  â”‚
â”‚  â”‚  â”‚ Subscribes to:  â”‚  â”‚ Subscribes to:  â”‚  â”‚ Subscribes to:  â”‚               â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ citizen.*     â”‚  â”‚ â€¢ citizen.*     â”‚  â”‚ â€¢ permit.*      â”‚               â”‚  â”‚
â”‚  â”‚  â”‚ Updates local   â”‚  â”‚ â€¢ payment.*     â”‚  â”‚ â€¢ payment.*     â”‚               â”‚  â”‚
â”‚  â”‚  â”‚ citizen_refs    â”‚  â”‚ Updates local   â”‚  â”‚ Sends emails,   â”‚               â”‚  â”‚
â”‚  â”‚  â”‚ table           â”‚  â”‚ cache           â”‚  â”‚ SMS, push       â”‚               â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Apache Kafka Implementation

### Kafka Architecture for Government Services

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         KAFKA CLUSTER ARCHITECTURE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           KAFKA CLUSTER                                        â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚
â”‚  â”‚   â”‚  Broker 1   â”‚    â”‚  Broker 2   â”‚    â”‚  Broker 3   â”‚                      â”‚  â”‚
â”‚  â”‚   â”‚  (Leader)   â”‚    â”‚  (Follower) â”‚    â”‚  (Follower) â”‚                      â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚   Topics:                                                                     â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚   â”‚  gov.auth.citizen         (Partitions: 6, Replication: 3)           â”‚    â”‚  â”‚
â”‚  â”‚   â”‚  gov.auth.employee        (Partitions: 3, Replication: 3)           â”‚    â”‚  â”‚
â”‚  â”‚   â”‚  gov.auth.role            (Partitions: 3, Replication: 3)           â”‚    â”‚  â”‚
â”‚  â”‚   â”‚  gov.permits.application  (Partitions: 6, Replication: 3)           â”‚    â”‚  â”‚
â”‚  â”‚   â”‚  gov.permits.inspection   (Partitions: 3, Replication: 3)           â”‚    â”‚  â”‚
â”‚  â”‚   â”‚  gov.revenue.payment      (Partitions: 6, Replication: 3)           â”‚    â”‚  â”‚
â”‚  â”‚   â”‚  gov.notification.send    (Partitions: 6, Replication: 3)           â”‚    â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        SUPPORTING SERVICES                                     â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚
â”‚  â”‚   â”‚   Schema Registry   â”‚    â”‚     ZooKeeper       â”‚                         â”‚  â”‚
â”‚  â”‚   â”‚                     â”‚    â”‚   (Coordination)    â”‚                         â”‚  â”‚
â”‚  â”‚   â”‚  â€¢ Avro schemas     â”‚    â”‚                     â”‚                         â”‚  â”‚
â”‚  â”‚   â”‚  â€¢ Version control  â”‚    â”‚  Or: KRaft mode     â”‚                         â”‚  â”‚
â”‚  â”‚   â”‚  â€¢ Compatibility    â”‚    â”‚  (ZK-less Kafka)    â”‚                         â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Topic Naming Convention

```
gov.<domain>.<entity>.<action>

Examples:
â”œâ”€â”€ gov.auth.citizen.created
â”œâ”€â”€ gov.auth.citizen.updated  
â”œâ”€â”€ gov.auth.citizen.deleted
â”œâ”€â”€ gov.auth.citizen.verified
â”œâ”€â”€ gov.auth.employee.assigned
â”œâ”€â”€ gov.auth.role.granted
â”œâ”€â”€ gov.auth.role.revoked
â”œâ”€â”€ gov.permits.application.submitted
â”œâ”€â”€ gov.permits.application.approved
â”œâ”€â”€ gov.permits.application.rejected
â”œâ”€â”€ gov.permits.inspection.scheduled
â”œâ”€â”€ gov.permits.inspection.completed
â”œâ”€â”€ gov.revenue.payment.initiated
â”œâ”€â”€ gov.revenue.payment.completed
â”œâ”€â”€ gov.revenue.payment.failed
â”œâ”€â”€ gov.revenue.refund.issued
â”œâ”€â”€ gov.notification.email.queued
â”œâ”€â”€ gov.notification.sms.queued
â””â”€â”€ gov.notification.push.queued
```

### Kafka Configuration

```yaml
# docker-compose.kafka.yml
version: '3.8'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log

  kafka-1:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_LOG_RETENTION_HOURS: 168  # 7 days
      KAFKA_LOG_RETENTION_BYTES: 10737418240  # 10GB
    volumes:
      - kafka-1-data:/var/lib/kafka/data

  kafka-2:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-2:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
    volumes:
      - kafka-2-data:/var/lib/kafka/data

  kafka-3:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-3:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
    volumes:
      - kafka-3-data:/var/lib/kafka/data

  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    depends_on:
      - kafka-1
      - schema-registry
    environment:
      KAFKA_CLUSTERS_0_NAME: gov-services
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
    ports:
      - "8080:8080"

volumes:
  zookeeper-data:
  zookeeper-logs:
  kafka-1-data:
  kafka-2-data:
  kafka-3-data:
```

### Consumer Group Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONSUMER GROUP DESIGN                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  Topic: gov.auth.citizen (6 partitions)                                    â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Consumer Group: permits-citizen-sync                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚
â”‚  â”‚  â”‚ Consumer 1 â”‚  â”‚ Consumer 2 â”‚  â”‚ Consumer 3 â”‚                     â”‚  â”‚
â”‚  â”‚  â”‚ P0, P1     â”‚  â”‚ P2, P3     â”‚  â”‚ P4, P5     â”‚                     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚
â”‚  â”‚  Purpose: Updates permits_db.citizen_refs                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Consumer Group: revenue-citizen-sync                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚
â”‚  â”‚  â”‚ Consumer 1 â”‚  â”‚ Consumer 2 â”‚                                     â”‚  â”‚
â”‚  â”‚  â”‚ P0, P1, P2 â”‚  â”‚ P3, P4, P5 â”‚                                     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚
â”‚  â”‚  Purpose: Updates revenue_db.citizen_refs                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Consumer Group: notification-citizen-events                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚  â”‚
â”‚  â”‚  â”‚ Consumer 1 â”‚                                                     â”‚  â”‚
â”‚  â”‚  â”‚ All partitions                                                   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚  â”‚
â”‚  â”‚  Purpose: Send welcome emails to new citizens                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚  Key Benefits:                                                             â”‚
â”‚  â€¢ Each group processes ALL messages independently                         â”‚
â”‚  â€¢ Partition assignment enables parallel processing                        â”‚
â”‚  â€¢ Consumer failures trigger automatic rebalancing                         â”‚
â”‚  â€¢ Offset tracking per group for replay capability                         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## AWS Services Integration

### AWS Event-Driven Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AWS EVENT-DRIVEN ARCHITECTURE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                              PRODUCERS                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  â”‚
â”‚  â”‚  â”‚  Auth Service   â”‚  â”‚ Permits Service â”‚  â”‚ Revenue Service â”‚                â”‚  â”‚
â”‚  â”‚  â”‚  (ECS/Lambda)   â”‚  â”‚  (ECS/Lambda)   â”‚  â”‚  (ECS/Lambda)   â”‚                â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                    â”‚                    â”‚                            â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                   â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         AMAZON EVENTBRIDGE                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                        Custom Event Bus                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                     "gov-services-event-bus"                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Rules:                                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Rule: citizen-events-to-permits                                   â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Pattern: { "source": ["gov.auth"], "detail-type": ["citizen.*"] } â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Target: SQS Queue - permits-citizen-sync                          â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Rule: citizen-events-to-revenue                                   â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Pattern: { "source": ["gov.auth"], "detail-type": ["citizen.*"] } â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Target: SQS Queue - revenue-citizen-sync                          â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Rule: notification-events                                         â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Pattern: { "detail-type": ["*.created", "*.approved"] }           â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â”‚ Target: Lambda - notification-dispatcher                          â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚                                                 â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚          â”‚                        â”‚                        â”‚                        â”‚
â”‚          â–¼                        â–¼                        â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   SQS Queue   â”‚       â”‚   SQS Queue   â”‚       â”‚    Lambda     â”‚                 â”‚
â”‚  â”‚ permits-sync  â”‚       â”‚ revenue-sync  â”‚       â”‚ notification  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚          â”‚                       â”‚                       â”‚                          â”‚
â”‚          â–¼                       â–¼                       â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚    Lambda     â”‚       â”‚    Lambda     â”‚       â”‚      SNS      â”‚                 â”‚
â”‚  â”‚ permits-sync  â”‚       â”‚ revenue-sync  â”‚       â”‚   + Pinpoint  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚          â”‚                       â”‚                                                  â”‚
â”‚          â–¼                       â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚  RDS/Aurora   â”‚       â”‚  RDS/Aurora   â”‚                                         â”‚
â”‚  â”‚  permits_db   â”‚       â”‚  revenue_db   â”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AWS Service Comparison

| Service | Best For | Pros | Cons |
|---------|----------|------|------|
| **EventBridge** | Event routing, serverless | Managed, pattern matching, low cost | 256KB message limit |
| **SQS** | Message queuing, decoupling | Guaranteed delivery, DLQ support | No pub/sub |
| **SNS** | Fan-out, notifications | Multi-protocol, filtering | No persistence |
| **Kinesis** | High-throughput streaming | Real-time, replay | More complex |
| **MSK (Managed Kafka)** | Full Kafka compatibility | All Kafka features | Higher cost |

### EventBridge Implementation

```python
# AWS EventBridge producer - Auth Service
import boto3
import json
from datetime import datetime

class EventBridgePublisher:
    def __init__(self):
        self.client = boto3.client('events')
        self.event_bus_name = 'gov-services-event-bus'
    
    def publish_citizen_created(self, citizen: dict):
        """Publish citizen.created event"""
        event = {
            'Source': 'gov.auth',
            'DetailType': 'citizen.created',
            'Detail': json.dumps({
                'event_id': f"evt_{citizen['id']}_{int(datetime.now().timestamp())}",
                'event_version': 1,
                'timestamp': datetime.utcnow().isoformat(),
                'data': {
                    'citizen_id': citizen['id'],
                    'snapshot': {
                        'id': citizen['id'],
                        'name': citizen['name'],
                        'email': citizen['email'],
                        'phone': citizen['phone'],
                        'address': citizen.get('address'),
                        'created_at': citizen['created_at']
                    }
                }
            }),
            'EventBusName': self.event_bus_name
        }
        
        response = self.client.put_events(Entries=[event])
        return response
    
    def publish_citizen_updated(self, citizen: dict, changes: dict):
        """Publish citizen.updated event"""
        event = {
            'Source': 'gov.auth',
            'DetailType': 'citizen.updated',
            'Detail': json.dumps({
                'event_id': f"evt_{citizen['id']}_{int(datetime.now().timestamp())}",
                'event_version': citizen.get('version', 1),
                'timestamp': datetime.utcnow().isoformat(),
                'data': {
                    'citizen_id': citizen['id'],
                    'changes': changes,
                    'snapshot': {
                        'id': citizen['id'],
                        'name': citizen['name'],
                        'email': citizen['email'],
                        'phone': citizen['phone'],
                        'address': citizen.get('address')
                    }
                }
            }),
            'EventBusName': self.event_bus_name
        }
        
        response = self.client.put_events(Entries=[event])
        return response
```

```python
# AWS Lambda consumer - Permits Sync
import json
import boto3
import psycopg2

def lambda_handler(event, context):
    """
    SQS trigger - receives citizen events from EventBridge
    """
    for record in event['Records']:
        body = json.loads(record['body'])
        detail = json.loads(body['detail']) if isinstance(body['detail'], str) else body['detail']
        
        detail_type = body['detail-type']
        
        if detail_type == 'citizen.created':
            handle_citizen_created(detail['data'])
        elif detail_type == 'citizen.updated':
            handle_citizen_updated(detail['data'])
        elif detail_type == 'citizen.deleted':
            handle_citizen_deleted(detail['data'])
    
    return {'statusCode': 200}

def handle_citizen_updated(data):
    """Update local citizen cache"""
    conn = get_db_connection()
    cursor = conn.cursor()
    
    snapshot = data['snapshot']
    event_version = data.get('event_version', 1)
    
    cursor.execute("""
        INSERT INTO cache.citizen_refs 
            (citizen_id, name, email, phone, address, event_version, last_synced_at)
        VALUES (%s, %s, %s, %s, %s, %s, NOW())
        ON CONFLICT (citizen_id) DO UPDATE SET
            name = EXCLUDED.name,
            email = EXCLUDED.email,
            phone = EXCLUDED.phone,
            address = EXCLUDED.address,
            event_version = EXCLUDED.event_version,
            last_synced_at = NOW()
        WHERE citizen_refs.event_version < EXCLUDED.event_version
    """, (
        snapshot['id'],
        snapshot['name'],
        snapshot['email'],
        snapshot['phone'],
        snapshot.get('address'),
        event_version
    ))
    
    conn.commit()
    cursor.close()
    conn.close()

def get_db_connection():
    return psycopg2.connect(
        host=os.environ['DB_HOST'],
        database='permits_db',
        user=os.environ['DB_SYNC_USER'],
        password=os.environ['DB_SYNC_PASSWORD']
    )
```

### Terraform Configuration (AWS)

```hcl
# eventbridge.tf

resource "aws_cloudwatch_event_bus" "gov_services" {
  name = "gov-services-event-bus"
}

# Rule: Route citizen events to permits service
resource "aws_cloudwatch_event_rule" "citizen_to_permits" {
  name           = "citizen-events-to-permits"
  event_bus_name = aws_cloudwatch_event_bus.gov_services.name
  
  event_pattern = jsonencode({
    source      = ["gov.auth"]
    detail-type = [
      "citizen.created",
      "citizen.updated",
      "citizen.deleted"
    ]
  })
}

resource "aws_cloudwatch_event_target" "citizen_to_permits_sqs" {
  rule           = aws_cloudwatch_event_rule.citizen_to_permits.name
  event_bus_name = aws_cloudwatch_event_bus.gov_services.name
  target_id      = "permits-citizen-sync-queue"
  arn            = aws_sqs_queue.permits_citizen_sync.arn
}

# SQS Queue for permits service
resource "aws_sqs_queue" "permits_citizen_sync" {
  name                       = "permits-citizen-sync"
  visibility_timeout_seconds = 300
  message_retention_seconds  = 1209600  # 14 days
  
  redrive_policy = jsonencode({
    deadLetterTargetArn = aws_sqs_queue.permits_citizen_sync_dlq.arn
    maxReceiveCount     = 3
  })
}

# Dead Letter Queue
resource "aws_sqs_queue" "permits_citizen_sync_dlq" {
  name                      = "permits-citizen-sync-dlq"
  message_retention_seconds = 1209600  # 14 days
}

# Lambda function for processing
resource "aws_lambda_function" "permits_citizen_sync" {
  filename         = "permits_sync.zip"
  function_name    = "permits-citizen-sync"
  role             = aws_iam_role.lambda_permits_sync.arn
  handler          = "handler.lambda_handler"
  runtime          = "python3.11"
  timeout          = 30
  memory_size      = 256
  
  environment {
    variables = {
      DB_HOST          = aws_db_instance.permits_db.endpoint
      DB_SYNC_USER     = "permits_sync_user"
      DB_SYNC_PASSWORD = data.aws_secretsmanager_secret_version.db_password.secret_string
    }
  }
  
  vpc_config {
    subnet_ids         = var.private_subnet_ids
    security_group_ids = [aws_security_group.lambda_sg.id]
  }
}

# Lambda trigger from SQS
resource "aws_lambda_event_source_mapping" "permits_sync_trigger" {
  event_source_arn = aws_sqs_queue.permits_citizen_sync.arn
  function_name    = aws_lambda_function.permits_citizen_sync.arn
  batch_size       = 10
}
```

---

## VPS Hosting Options

### Self-Hosted Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VPS SELF-HOSTED ARCHITECTURE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      VPS Provider Options                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚   Hetzner   â”‚ â”‚DigitalOceanâ”‚ â”‚   Vultr     â”‚ â”‚   Linode    â”‚            â”‚   â”‚
â”‚  â”‚  â”‚   â‚¬4/mo+    â”‚ â”‚  $6/mo+    â”‚ â”‚   $6/mo+    â”‚ â”‚   $5/mo+    â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  Recommended Configuration:                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                        â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         3-Node Kafka Cluster                                  â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  Node 1: 8GB RAM, 4 vCPU, 160GB NVMe    â†’ $48/mo (DigitalOcean)              â”‚  â”‚
â”‚  â”‚  Node 2: 8GB RAM, 4 vCPU, 160GB NVMe    â†’ $48/mo                             â”‚  â”‚
â”‚  â”‚  Node 3: 8GB RAM, 4 vCPU, 160GB NVMe    â†’ $48/mo                             â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  Total Kafka Cluster: ~$144/mo                                                â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  Alternative: Use Upstash Kafka (Serverless)                                  â”‚  â”‚
â”‚  â”‚  â€¢ Pay per message                                                            â”‚  â”‚
â”‚  â”‚  â€¢ Free tier: 10K messages/day                                                â”‚  â”‚
â”‚  â”‚  â€¢ Scale as needed                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Lightweight Alternative: RabbitMQ                          â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚  â”‚
â”‚  â”‚  â”‚   RabbitMQ Cluster  â”‚   2 nodes for HA                                     â”‚  â”‚
â”‚  â”‚  â”‚   4GB RAM, 2 vCPU   â”‚   ~$24/mo each = $48/mo total                        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  Pros:                                                                        â”‚  â”‚
â”‚  â”‚  â€¢ Lower resource requirements                                                â”‚  â”‚
â”‚  â”‚  â€¢ Built-in management UI                                                     â”‚  â”‚
â”‚  â”‚  â€¢ Multiple protocols (AMQP, MQTT, STOMP)                                     â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  Cons:                                                                        â”‚  â”‚
â”‚  â”‚  â€¢ No log compaction (can't replay full history)                              â”‚  â”‚
â”‚  â”‚  â€¢ Lower throughput than Kafka                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   Ultra-Lightweight: Redis Streams                            â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚  â”‚
â”‚  â”‚  â”‚   Redis Sentinel    â”‚   3 nodes for HA                                     â”‚  â”‚
â”‚  â”‚  â”‚   2GB RAM each      â”‚   ~$12/mo each = $36/mo total                        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚  â”‚
â”‚  â”‚                                                                               â”‚  â”‚
â”‚  â”‚  Best for:                                                                    â”‚  â”‚
â”‚  â”‚  â€¢ Smaller deployments (< 1000 events/sec)                                    â”‚  â”‚
â”‚  â”‚  â€¢ Teams already using Redis                                                  â”‚  â”‚
â”‚  â”‚  â€¢ Simple pub/sub needs                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RabbitMQ Configuration (VPS)

```yaml
# docker-compose.rabbitmq.yml
version: '3.8'

services:
  rabbitmq-1:
    image: rabbitmq:3.12-management
    hostname: rabbitmq-1
    environment:
      RABBITMQ_ERLANG_COOKIE: "gov-secret-cookie"
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_PASSWORD}"
      RABBITMQ_DEFAULT_VHOST: gov_services
    volumes:
      - rabbitmq-1-data:/var/lib/rabbitmq
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./definitions.json:/etc/rabbitmq/definitions.json
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    networks:
      - rabbitmq-cluster

  rabbitmq-2:
    image: rabbitmq:3.12-management
    hostname: rabbitmq-2
    environment:
      RABBITMQ_ERLANG_COOKIE: "gov-secret-cookie"
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_PASSWORD}"
    volumes:
      - rabbitmq-2-data:/var/lib/rabbitmq
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    depends_on:
      - rabbitmq-1
    networks:
      - rabbitmq-cluster

volumes:
  rabbitmq-1-data:
  rabbitmq-2-data:

networks:
  rabbitmq-cluster:
    driver: bridge
```

```json
// definitions.json - Exchange and Queue setup
{
  "exchanges": [
    {
      "name": "gov.auth.events",
      "vhost": "gov_services",
      "type": "topic",
      "durable": true
    },
    {
      "name": "gov.permits.events",
      "vhost": "gov_services", 
      "type": "topic",
      "durable": true
    },
    {
      "name": "gov.revenue.events",
      "vhost": "gov_services",
      "type": "topic",
      "durable": true
    }
  ],
  "queues": [
    {
      "name": "permits.citizen.sync",
      "vhost": "gov_services",
      "durable": true,
      "arguments": {
        "x-dead-letter-exchange": "dlx",
        "x-message-ttl": 604800000
      }
    },
    {
      "name": "revenue.citizen.sync",
      "vhost": "gov_services",
      "durable": true,
      "arguments": {
        "x-dead-letter-exchange": "dlx"
      }
    },
    {
      "name": "notification.events",
      "vhost": "gov_services",
      "durable": true
    }
  ],
  "bindings": [
    {
      "source": "gov.auth.events",
      "vhost": "gov_services",
      "destination": "permits.citizen.sync",
      "destination_type": "queue",
      "routing_key": "citizen.#"
    },
    {
      "source": "gov.auth.events",
      "vhost": "gov_services",
      "destination": "revenue.citizen.sync",
      "destination_type": "queue",
      "routing_key": "citizen.#"
    }
  ]
}
```

### Redis Streams Implementation

```python
# Redis Streams producer
import redis
import json
from datetime import datetime

class RedisEventPublisher:
    def __init__(self):
        self.redis = redis.Redis(
            host='redis-primary',
            port=6379,
            decode_responses=True
        )
    
    def publish_citizen_event(self, event_type: str, citizen: dict):
        """Publish event to Redis Stream"""
        stream_name = 'gov:auth:citizen'
        
        event = {
            'event_type': event_type,
            'event_id': f"evt_{citizen['id']}_{int(datetime.now().timestamp())}",
            'timestamp': datetime.utcnow().isoformat(),
            'data': json.dumps({
                'citizen_id': citizen['id'],
                'snapshot': citizen
            })
        }
        
        # XADD with MAXLEN to limit stream size
        message_id = self.redis.xadd(
            stream_name,
            event,
            maxlen=100000  # Keep last 100K messages
        )
        
        return message_id

# Redis Streams consumer
class RedisEventConsumer:
    def __init__(self, consumer_group: str, consumer_name: str):
        self.redis = redis.Redis(
            host='redis-primary',
            port=6379,
            decode_responses=True
        )
        self.stream = 'gov:auth:citizen'
        self.group = consumer_group
        self.consumer = consumer_name
        
        # Create consumer group if not exists
        try:
            self.redis.xgroup_create(
                self.stream,
                self.group,
                id='0',
                mkstream=True
            )
        except redis.ResponseError:
            pass  # Group already exists
    
    def consume_events(self):
        """Consume events from stream"""
        while True:
            # Read new messages
            messages = self.redis.xreadgroup(
                self.group,
                self.consumer,
                {self.stream: '>'},
                count=10,
                block=5000  # 5 second timeout
            )
            
            for stream, events in messages:
                for message_id, event in events:
                    try:
                        self.process_event(event)
                        # Acknowledge successful processing
                        self.redis.xack(self.stream, self.group, message_id)
                    except Exception as e:
                        print(f"Error processing {message_id}: {e}")
    
    def process_event(self, event: dict):
        """Process a single event"""
        data = json.loads(event['data'])
        event_type = event['event_type']
        
        if event_type == 'citizen.created':
            self.handle_citizen_created(data)
        elif event_type == 'citizen.updated':
            self.handle_citizen_updated(data)
```

### Cost Comparison

| Solution | Monthly Cost | Throughput | Best For |
|----------|-------------|------------|----------|
| **Self-hosted Kafka (3 nodes)** | ~$144/mo | 100K+ msg/sec | Large scale, full features |
| **AWS MSK (Managed Kafka)** | ~$500+/mo | 100K+ msg/sec | AWS-native, managed |
| **AWS EventBridge + SQS** | ~$20-50/mo | 10K msg/sec | Serverless, AWS-native |
| **Upstash Kafka** | $0-100/mo | 10K msg/sec | Serverless, easy start |
| **Self-hosted RabbitMQ** | ~$48/mo | 50K msg/sec | Medium scale, flexible |
| **Self-hosted Redis Streams** | ~$36/mo | 100K+ msg/sec | Simple pub/sub, existing Redis |
| **CloudAMQP (Managed RabbitMQ)** | ~$20-200/mo | Variable | Managed, easy setup |

---

## Event Schema Design

### Event Schema Registry

```json
// Schema: gov.auth.citizen.v1.avsc
{
  "type": "record",
  "name": "CitizenEvent",
  "namespace": "gov.auth.citizen",
  "fields": [
    {
      "name": "event_id",
      "type": "string",
      "doc": "Unique event identifier"
    },
    {
      "name": "event_type",
      "type": {
        "type": "enum",
        "name": "CitizenEventType",
        "symbols": ["CREATED", "UPDATED", "DELETED", "VERIFIED"]
      }
    },
    {
      "name": "event_version",
      "type": "long",
      "doc": "Version for ordering and deduplication"
    },
    {
      "name": "timestamp",
      "type": {
        "type": "long",
        "logicalType": "timestamp-millis"
      }
    },
    {
      "name": "correlation_id",
      "type": ["null", "string"],
      "default": null,
      "doc": "For request tracing"
    },
    {
      "name": "data",
      "type": {
        "type": "record",
        "name": "CitizenEventData",
        "fields": [
          {
            "name": "citizen_id",
            "type": "long"
          },
          {
            "name": "changes",
            "type": ["null", {
              "type": "map",
              "values": {
                "type": "record",
                "name": "FieldChange",
                "fields": [
                  {"name": "old_value", "type": ["null", "string"]},
                  {"name": "new_value", "type": ["null", "string"]}
                ]
              }
            }],
            "default": null
          },
          {
            "name": "snapshot",
            "type": {
              "type": "record",
              "name": "CitizenSnapshot",
              "fields": [
                {"name": "id", "type": "long"},
                {"name": "name", "type": "string"},
                {"name": "email", "type": "string"},
                {"name": "phone", "type": ["null", "string"]},
                {"name": "address", "type": ["null", "string"]},
                {"name": "email_verified", "type": "boolean"},
                {"name": "identity_verified", "type": "boolean"}
              ]
            }
          }
        ]
      }
    }
  ]
}
```

### JSON Event Examples

```json
// citizen.created
{
  "event_id": "evt_123_1705312200",
  "event_type": "citizen.created",
  "event_version": 1,
  "timestamp": "2024-01-15T10:30:00Z",
  "correlation_id": "req_abc123",
  "source": {
    "service": "auth-service",
    "instance": "auth-1",
    "version": "1.2.0"
  },
  "data": {
    "citizen_id": 123,
    "snapshot": {
      "id": 123,
      "name": "Maria Garcia",
      "email": "maria@email.com",
      "phone": "+1-555-0123",
      "address": "456 Main St, Springfield",
      "email_verified": false,
      "identity_verified": false,
      "created_at": "2024-01-15T10:30:00Z"
    }
  }
}

// citizen.updated
{
  "event_id": "evt_123_1705398600",
  "event_type": "citizen.updated",
  "event_version": 5,
  "timestamp": "2024-01-16T10:30:00Z",
  "correlation_id": "req_def456",
  "source": {
    "service": "auth-service",
    "instance": "auth-2"
  },
  "data": {
    "citizen_id": 123,
    "changes": {
      "phone": {
        "old": "+1-555-0123",
        "new": "+1-555-0199"
      },
      "address": {
        "old": "456 Main St, Springfield",
        "new": "789 Oak Ave, Springfield"
      }
    },
    "snapshot": {
      "id": 123,
      "name": "Maria Garcia",
      "email": "maria@email.com",
      "phone": "+1-555-0199",
      "address": "789 Oak Ave, Springfield",
      "email_verified": true,
      "identity_verified": true
    }
  }
}

// citizen.verified
{
  "event_id": "evt_123_1705485000",
  "event_type": "citizen.verified",
  "event_version": 6,
  "timestamp": "2024-01-17T10:30:00Z",
  "data": {
    "citizen_id": 123,
    "verification_type": "identity",
    "verified_by": "employee_456",
    "verification_method": "in_person",
    "document_reference": "doc_789"
  }
}
```

---

## Monitoring & Operations

### Monitoring Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EVENT SYSTEM MONITORING                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Key Metrics to Monitor                                              â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Producer Metrics:                                                   â”‚  â”‚
â”‚  â”‚  â€¢ Messages produced/sec                                             â”‚  â”‚
â”‚  â”‚  â€¢ Producer latency (p50, p95, p99)                                 â”‚  â”‚
â”‚  â”‚  â€¢ Failed publishes                                                  â”‚  â”‚
â”‚  â”‚  â€¢ Batch size                                                        â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Consumer Metrics:                                                   â”‚  â”‚
â”‚  â”‚  â€¢ Messages consumed/sec                                             â”‚  â”‚
â”‚  â”‚  â€¢ Consumer lag (critical!)                                          â”‚  â”‚
â”‚  â”‚  â€¢ Processing time per message                                       â”‚  â”‚
â”‚  â”‚  â€¢ Failed processing (DLQ count)                                     â”‚  â”‚
â”‚  â”‚  â€¢ Rebalance frequency                                               â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Broker Metrics (Kafka):                                             â”‚  â”‚
â”‚  â”‚  â€¢ Under-replicated partitions                                       â”‚  â”‚
â”‚  â”‚  â€¢ Active controller count                                           â”‚  â”‚
â”‚  â”‚  â€¢ Disk usage per broker                                             â”‚  â”‚
â”‚  â”‚  â€¢ Network throughput                                                â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Monitoring Stack                                                    â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚ Prometheus  â”‚â”€â”€â”‚  Grafana    â”‚  â”‚ AlertManagerâ”‚                  â”‚  â”‚
â”‚  â”‚  â”‚ (Metrics)   â”‚  â”‚ (Dashboard) â”‚  â”‚  (Alerts)   â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  AWS Alternative:                                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚ CloudWatch  â”‚â”€â”€â”‚ CloudWatch  â”‚â”€â”€â”‚     SNS     â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚  Metrics    â”‚  â”‚ Dashboards  â”‚  â”‚   Alerts    â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Alert Rules

```yaml
# prometheus/alerts.yml
groups:
  - name: kafka-alerts
    rules:
      - alert: KafkaConsumerLagHigh
        expr: kafka_consumer_group_lag > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Consumer lag is high"
          description: "Consumer group {{ $labels.group }} has lag of {{ $value }}"
      
      - alert: KafkaConsumerLagCritical
        expr: kafka_consumer_group_lag > 100000
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Consumer lag is critical"
          description: "Consumer group {{ $labels.group }} - immediate attention needed"
      
      - alert: DeadLetterQueueGrowing
        expr: increase(dlq_message_count[1h]) > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "DLQ messages increasing"
          description: "Dead letter queue {{ $labels.queue }} has {{ $value }} new messages"
      
      - alert: EventPublishFailures
        expr: rate(event_publish_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Event publishing failures detected"
```

### Health Check Endpoints

```python
# health.py - Event system health checks
from fastapi import FastAPI, HTTPException
from kafka import KafkaConsumer
import redis

app = FastAPI()

@app.get("/health/events")
async def event_system_health():
    """Check event system health"""
    health = {
        "status": "healthy",
        "checks": {}
    }
    
    # Check Kafka connectivity
    try:
        consumer = KafkaConsumer(
            bootstrap_servers=['kafka:9092'],
            request_timeout_ms=5000
        )
        topics = consumer.topics()
        consumer.close()
        health["checks"]["kafka"] = {
            "status": "healthy",
            "topics_count": len(topics)
        }
    except Exception as e:
        health["checks"]["kafka"] = {
            "status": "unhealthy",
            "error": str(e)
        }
        health["status"] = "unhealthy"
    
    # Check consumer lag
    try:
        lag = get_consumer_lag("permits-citizen-sync")
        health["checks"]["permits_sync_lag"] = {
            "status": "healthy" if lag < 1000 else "degraded",
            "lag": lag
        }
    except Exception as e:
        health["checks"]["permits_sync_lag"] = {
            "status": "unknown",
            "error": str(e)
        }
    
    if health["status"] == "unhealthy":
        raise HTTPException(status_code=503, detail=health)
    
    return health
```
